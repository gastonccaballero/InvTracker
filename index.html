<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Inventory & Events ‚Äî Single‚ÄëFile App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--bg:#0b0f14;--card:#121821;--muted:#1b2330;--text:#e9eef6;--soft:#a7b0bf;--acc:#6aa2ff;--acc2:#32d6a0;--warn:#ffb020;--bad:#ff5d73;--ok:#6ee7b7;--ring:0 0 0 2px #6aa2ff55;--radius:14px}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:linear-gradient(180deg,#08101a,#0b0f14 25%,#0b0f14);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
a{color:var(--acc)}
.container{max-width:1200px;margin:0 auto;padding:24px}
.header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:16px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:34px;height:34px;display:grid;place-items:center;border-radius:10px;background:linear-gradient(135deg,var(--acc),#7b66ff)}
h1{font-size:18px;margin:0}
.toolbar{display:flex;gap:8px;flex-wrap:wrap}
button,.btn{background:var(--muted);color:var(--text);border:1px solid #ffffff1a;border-radius:12px;padding:8px 12px;cursor:pointer}
button:hover,.btn:hover{border-color:#ffffff33}
button.primary{background:linear-gradient(135deg,#3a7bff,#6aa2ff);border-color:#0000;color:white}
button.green{background:linear-gradient(135deg,#1fbf8f,#36d79f);border-color:#0000;color:#042}
button.warn{background:linear-gradient(135deg,#ffb020,#ff795a);border-color:#0000;color:#2b1800}
button.ghost{background:transparent;border-color:#ffffff26}
input,select,textarea{background:#0f141c;border:1px solid #ffffff1a;border-radius:10px;color:var(--text);padding:8px 10px;outline:none}
input:focus,select:focus,textarea:focus{box-shadow:var(--ring);border-color:#6aa2ff80}
.grid{display:grid;gap:14px}
.cards{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
.card{grid-column:span 12;background:var(--card);border:1px solid #ffffff14;border-radius:var(--radius);padding:14px}
.card h3{margin:0 0 10px 0;font-size:16px}
@media(min-width:900px){.card.span6{grid-column:span 6}.card.span4{grid-column:span 4}.card.span8{grid-column:span 8}}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th,.table td{text-align:left;padding:10px 12px}
.table thead th{font-size:12px;letter-spacing:.02em;color:var(--soft)}
.table tbody tr{background:#0f141c;border:1px solid #ffffff12}
.table tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
.table tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
.row-actions{display:flex;gap:6px;flex-wrap:wrap}
.kbd{font:12px/1 Menlo,Consolas,monospace;background:#00000066;border:1px solid #ffffff1a;border-radius:6px;padding:2px 6px;color:#cfe}
.badge{padding:2px 8px;border-radius:999px;border:1px solid #ffffff20;background:#09121b;color:#cde;font-size:12px}
.tag{padding:2px 6px;border-radius:6px;background:#152033;border:1px solid #ffffff1a;color:#9dc2ff;font-size:12px;margin-right:6px}
.low{background:#2a1720;border-color:#ff8aa1;color:#ffc1cb}
.good{background:#13271f;border-color:#3fd3a1;color:#aef5dc}
.nav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.nav .tab{padding:8px 10px;border-radius:10px;border:1px solid #ffffff1a;background:#0f141c;cursor:pointer}
/* Color wheel transition for tab buttons */
.nav .tab.active[data-tab="tab-dashboard"]{background:linear-gradient(135deg,#10b981,#34d399);border-color:#0000;color:white}
.nav .tab.active[data-tab="tab-inventory"]{background:linear-gradient(135deg,#06b6d4,#22d3ee);border-color:#0000;color:white}
.nav .tab.active[data-tab="tab-events"]{background:linear-gradient(135deg,#3b82f6,#60a5fa);border-color:#0000;color:white}
.nav .tab.active[data-tab="tab-customers"]{background:linear-gradient(135deg,#8b5cf6,#a78bfa);border-color:#0000;color:white}
.nav .tab.active[data-tab="tab-checkout"]{background:linear-gradient(135deg,#ec4899,#f472b6);border-color:#0000;color:white}
.nav .tab.active[data-tab="tab-returns"]{background:linear-gradient(135deg,#f59e0b,#fbbf24);border-color:#0000;color:white}
.nav .tab.active[data-tab="tab-reports"]{background:linear-gradient(135deg,#ef4444,#f87171);border-color:#0000;color:white}
.nav .tab.active[data-tab="tab-templates"]{background:linear-gradient(135deg,#dc2626,#dc2626);border-color:#0000;color:white}
.hidden{display:none!important}
.flex{display:flex;gap:10px;flex-wrap:wrap}
.right{margin-left:auto}
.searchbar{display:flex;gap:8px;align-items:center}
small.mono{font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#b9c3d6}
hr.sep{border:none;border-top:1px solid #ffffff14;margin:8px 0}
.totals table{width:260px;border-collapse:collapse}
.totals td,.totals th{padding:6px 8px;border-bottom:1px dashed #ffffff1a}
.invoice{background:white;color:black;border-radius:12px;padding:18px;border:1px solid #00000022}
.invoice table{width:100%;border-collapse:collapse}
.invoice th,.invoice td{padding:8px;border-bottom:1px solid #00000018}
.invoice h2{margin:0 0 8px 0}
.invoice small{color:#333}
#invoiceArea.active{display:block}
#invoiceArea{display:none}
dialog{border:1px solid #ffffff22;background:var(--card);color:var(--text);border-radius:16px;padding:0;max-width:1200px;width:clamp(320px,95vw,1200px)}
dialog::backdrop{background:#0008}
#coAddDialog{max-width:1200px;width:clamp(360px,95vw,1200px)}
.dialog-head{padding:12px 14px;border-bottom:1px solid #ffffff14;display:flex;align-items:center;gap:10px}
.dialog-body{padding:14px}
.dialog-actions{padding:12px 14px;border-top:1px solid #ffffff14;display:flex;gap:8px;justify-content:flex-end}
.formgrid{display:grid;grid-template-columns:repeat(15,1fr);gap:16px}
.formgrid .col6{grid-column:span 12}@media(min-width:800px){.formgrid .col6{grid-column:span 6}}
.formgrid .col4{grid-column:span 12}@media(min-width:800px){.formgrid .col4{grid-column:span 4}}
.formgrid .col3{grid-column:span 15}@media(min-width:800px){.formgrid .col3{grid-column:span 3}}
@media(max-width:799px){.formgrid .col3{grid-column:span 15}}
.formgrid .col12{grid-column:span 12}
.note{padding:8px 10px;border:1px dashed #ffffff2a;background:#0e151d;border-radius:10px;color:#c9d4e6}
footer{opacity:.7;margin-top:10px;font-size:12px}

/* Confirmation Modal Styles */
.confirm-modal {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  background: rgba(0, 0, 0, 0.7) !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  z-index: 10000 !important;
  backdrop-filter: blur(4px) !important;
  padding: 20px !important;
  box-sizing: border-box !important;
  margin: 0 !important;
}

.confirm-modal-content {
  background: var(--card) !important;
  border: 1px solid #ffffff22 !important;
  border-radius: 16px !important;
  max-width: 400px !important;
  width: 100% !important;
  max-height: 90vh !important;
  overflow-y: auto !important;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
  animation: modalSlideIn 0.2s ease-out !important;
  margin: auto !important;
  position: relative !important;
  transform: none !important;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.confirm-modal-header {
  padding: 20px 24px 0 24px;
  border-bottom: 1px solid #ffffff14;
}

.confirm-modal-header h3 {
  margin: 0;
  color: #e2e8f0;
  font-size: 18px;
  font-weight: 600;
}

.confirm-modal-body {
  padding: 20px 24px;
}

.confirm-modal-body p {
  margin: 0;
  color: #c9d4e6;
  font-size: 14px;
  line-height: 1.5;
}

.confirm-modal-actions {
  padding: 0 24px 20px 24px;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.confirm-modal-actions .btn {
  min-width: 80px;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 500;
}
@media print{
  body{background:white}
  .header,.nav,.toolbar,.no-print{display:none!important}
  #invoiceArea{display:block}
  #invoiceArea .invoice{box-shadow:none;border:0;padding:0}
}

/* Image Upload Styles */
.image-upload-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: flex-start;
}

.image-preview {
  width: 200px;
  height: 200px;
  border: 2px dashed #ffffff33;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: border-color 0.2s;
}

.image-preview:hover {
  border-color: #6aa2ff;
}

.upload-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  color: #a7b0bf;
}

.upload-placeholder span:first-child {
  font-size: 24px;
}

.inventory-image {
  width: 40px;
  height: 40px;
  object-fit: cover;
  border-radius: 6px;
  border: 1px solid #ffffff1a;
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2l8 5v10l-8 5-8-5V7l8-5Z" fill="#ffffff22"/><path d="M12 4l6 3.75V16.5L12 20l-6-3.5V7.75L12 4Z" fill="white" opacity=".85"/></svg>
      </div>
      <h1>Inventory & Event Checkout</h1>
      <span class="badge">local only</span>
    </div>
    <div class="toolbar">
      <button id="btnSettings" class="ghost" title="Settings">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="nav no-print">
    <button class="tab active" data-tab="tab-dashboard">Dashboard</button>
    <button class="tab" data-tab="tab-inventory">Inventory</button>
    <button class="tab" data-tab="tab-events">Events</button>
    <button class="tab" data-tab="tab-customers">Customers</button>
    <button class="tab" data-tab="tab-checkout">Checkouts</button>
    <button class="tab" data-tab="tab-returns">Returns</button>
    <button class="tab" data-tab="tab-reports">Reports & Invoices</button>
    <button class="tab" data-tab="tab-templates">Invoice Templates</button>
    <div class="right"></div>
  </div>

  <!-- DASHBOARD -->
  <section id="tab-dashboard" class="grid">
    <div class="cards">
      <div class="card span12">
        <h3>Analytics</h3>
        <div class="grid" style="gap:12px">
          <div class="cards">
            <div class="card span4">
              <h3>Total Inventory Value</h3>
              <div id="dbInvValue" class="badge">$0.00</div>
            </div>
            <div class="card span4">
              <h3>Utilization (Items Out)</h3>
              <div id="dbUtilization" class="badge">0%</div>
            </div>
            <div class="card span4">
              <h3>Revenue (Last 30 days)</h3>
              <div id="dbRevenue30" class="badge">$0.00</div>
            </div>
          </div>
          <div class="cards">
            <div class="card span6">
              <h3>Top Categories (by items)</h3>
              <div id="dbTopCats" class="grid"></div>
            </div>
            <div class="card span6">
              <h3>Low Stock Items</h3>
              <div id="dbLowList" class="grid"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card span6">
        <h3>Quick Stats</h3>
        <div class="flex">
          <div class="badge">Items: <span id="dbStatItems">0</span></div>
          <div class="badge">Low stock: <span id="dbStatLow">0</span></div>
          <div class="badge">Events: <span id="dbStatEvents">0</span></div>
          <div class="badge">Checkouts: <span id="dbStatCO">0</span></div>
          <div class="badge">Customers: <span id="dbStatCustomers">0</span></div>
        </div>
      </div>

      <div class="card span6">
        <h3 style="margin-top:0">Recent Activity <small class="mono" id="dbActCount"></small></h3>
        <table class="table">
          <thead><tr><th>Date</th><th>Type</th><th>Ref</th><th>Details</th></tr></thead>
          <tbody id="dbActBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  

  <!-- INVENTORY -->
  <section id="tab-inventory" class="grid hidden">
    <div class="card">
      <div class="flex" style="align-items:center">
        <h3 style="margin-right:auto">Inventory</h3>
        <div class="searchbar">
          <input id="invSearch" placeholder="Search name, SKU, category‚Ä¶">
          <select id="invFilterCategory"><option value="">All categories</option></select>
          <select id="invFilterLow"><option value="">Stock</option><option value="low">Low only</option><option value="ok">Sufficient</option></select>
          <button id="btnAddItem" class="primary">Add Item</button>
        </div>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Image</th><th>SKU</th><th>Name</th><th>Category</th><th>Loc</th><th>Unit</th>
            <th>Qty (Avail/Total)</th><th>Price</th><th>Safety</th><th>Tags</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="invBody"></tbody>
      </table>
      <footer><small class="mono" id="invCount"></small></footer>
    </div>
  </section>

  <!-- EVENTS -->
  <section id="tab-events" class="grid hidden">
    <div class="card">
      <div class="flex" style="align-items:center">
        <h3 style="margin-right:auto">Events</h3>
        <div class="searchbar">
          <input id="evtSearch" placeholder="Search event or client‚Ä¶">
          <button id="btnAddEvent" class="primary">Add Event</button>
        </div>
      </div>
      <table class="table">
        <thead><tr><th>Name</th><th>Client</th><th>Date</th><th>Location</th><th>Status</th><th>Contact</th><th>Actions</th></tr></thead>
        <tbody id="evtBody"></tbody>
      </table>
      <footer><small class="mono" id="evtCount"></small></footer>
    </div>
  </section>

  <!-- CUSTOMERS -->
  <section id="tab-customers" class="grid hidden">
    <div class="card">
      <div class="flex" style="align-items:center">
        <h3 style="margin-right:auto">Customers</h3>
        <div class="searchbar">
          <input id="custSearch" placeholder="Search name, email, phone‚Ä¶">
          <button id="btnAddCustomer" class="primary">Add Customer</button>
        </div>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Contact</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Discount</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="custBody"></tbody>
      </table>
      <footer><small class="mono" id="custCount"></small></footer>
    </div>
  </section>

  <!-- CHECKOUTS -->
  <section id="tab-checkout" class="grid hidden">
    <div class="cards">
      <div class="card span12">
        <h3>Create Checkout</h3>
        <div class="flex">
          <select id="coEvent"></select>
          <input id="coDue" type="date" title="Due date">
          <div class="right"></div>
          <button id="btnOpenCoAdd" class="primary">Add Inventory</button>
        </div>
        <div class="flex" style="gap:12px;align-items:center;margin-top:8px">
          <select id="coCustomer" style="min-width:220px"></select>
          <div class="badge">Customer discount: <span id="coCustDiscLabel">‚Äî</span></div>
          <div class="right"></div>
          <div class="flex" style="gap:8px;align-items:center">
            <label>Manual Discount
              <select id="coManualDiscType">
                <option value="none">None</option>
                <option value="percent">% Percent</option>
                <option value="amount">$ Amount</option>
              </select>
            </label>
            <input id="coManualDiscValue" type="number" step="0.01" min="0" value="0" style="width:120px">
          </div>
        </div>
        <hr class="sep">
        <h3>Checkout Lines</h3>
        <table class="table">
          <thead><tr><th>SKU</th><th>Item</th><th style="width:80px">Qty</th><th style="width:110px">Unit</th><th style="width:120px">Line</th><th>Actions</th></tr></thead>
          <tbody id="coLines"></tbody>
        </table>
        <div class="flex" style="align-items:center;margin-top:6px">
          <div class="note">Tip: use <span class="kbd">Tab</span> to move between qty/price fields.</div>
          <div class="right"></div>
          <div class="totals">
            <table>
              <tr><th>Subtotal</th><td id="coSubtotal" style="text-align:right">$0.00</td></tr>
              <tr id="coCustDiscRow" style="display:none"><th>Customer Discount</th><td id="coCustDiscount" style="text-align:right">$0.00</td></tr>
              <tr id="coManualDiscRow" style="display:none"><th id="coManualDiscLabel">Discount</th><td id="coManualDiscount" style="text-align:right">$0.00</td></tr>
              <tr><th>Tax</th><td id="coTax" style="text-align:right">$0.00</td></tr>
              <tr><th>Total</th><td id="coTotal" style="text-align:right"><strong>$0.00</strong></td></tr>
            </table>
          </div>
        </div>
        <div class="flex" style="justify-content:flex-end;margin-top:8px">
          <button id="btnClearCo" class="ghost">Clear</button>
          <button id="btnFinalizeCo" class="green">Finalize Checkout</button>
        </div>
      </div>
    </div>
  </section>

  <!-- RETURNS -->
  <section id="tab-returns" class="grid hidden">
    <div class="cards">
      <div class="card span12">
        <h3>Process Returns</h3>
        <div class="flex">
          <select id="retCheckout"></select>
          <button id="btnLoadReturns" class="ghost">Load</button>
        </div>
        <table class="table" style="margin-top:8px">
          <thead><tr><th>SKU</th><th>Item</th><th>Out</th><th>Returned</th><th>Now</th></tr></thead>
          <tbody id="retBody"></tbody>
        </table>
        <div class="flex" style="justify-content:flex-end;margin-top:8px">
          <button id="btnProcessReturns" class="warn">Process Returns</button>
        </div>
      </div>
    </div>
  </section>

  <!-- REPORTS -->
  <section id="tab-reports" class="grid hidden">
    <div class="cards">
      <div class="card span12">
        <div class="flex" style="align-items:center">
          <h3>Invoices</h3>
          <div class="right"></div>
          <label class="flex" style="align-items:center;gap:6px"><input type="checkbox" id="togglePrices" checked> Show prices</label>
        </div>
        <div class="flex">
          <select id="invoiceSelect" style="min-width:280px"></select>
          <button id="btnOpenInvoice" class="ghost">Open</button>
          <button id="btnPrintInvoice" class="primary">Print</button>
        </div>
        <div id="invoiceArea" style="margin-top:12px"></div>
      </div>
    </div>
  </section>

  <!-- INVOICE TEMPLATES -->
  <section id="tab-templates" class="grid hidden">
    <div class="card">
      <h3>Invoice Templates</h3>
      <p>Invoice templates functionality coming soon...</p>
    </div>
  </section>

  <footer class="no-print">
    <!-- Footer content removed -->
  </footer>
</div>

<!-- CHECKOUT: ADD INVENTORY DIALOG -->
<dialog id="coAddDialog">
  <div class="dialog-head">
    <strong>Add Inventory</strong>
    <div class="right"></div>
    <button class="ghost" data-close>Close</button>
  </div>
  <div class="dialog-body">
    <div class="searchbar" style="margin-bottom:8px">
      <input id="coAddSearch" placeholder="Search SKU, name, category‚Ä¶">
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>Image</th><th>SKU</th><th>Name</th><th>Category</th><th>Loc</th><th>Unit</th>
          <th>Qty (Avail/Total)</th><th>Price</th><th>Safety</th><th>Tags</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="coAddBody"></tbody>
    </table>
  </div>
  <div class="dialog-actions">
    <button class="ghost" data-close>Cancel</button>
    <button id="btnCoAddSave" class="green">Save</button>
  </div>
  </dialog>

<!-- CUSTOMER DIALOG -->
<dialog id="custDialog">
  <div class="dialog-head">
    <strong id="custDialogTitle">New Customer</strong>
    <div class="right"></div>
    <button class="ghost" data-close>Close</button>
  </div>
  <div class="dialog-body">
    <form id="custForm" class="formgrid">
      <input type="hidden" name="id">
      <div class="col6"><label>Name / Company<br><input name="name" required></label></div>
      <div class="col6"><label>Contact<br><input name="contact" placeholder="Person"></label></div>
      <div class="col6"><label>Email<br><input name="email" type="email"></label></div>
      <div class="col6"><label>Phone<br><input name="phone"></label></div>
      <div class="col6"><label>Discount Type<br>
        <select name="discount_type">
          <option value="none">None</option>
          <option value="percent">Percent %</option>
          <option value="amount">Amount $</option>
        </select>
      </label></div>
      <div class="col6"><label>Discount Value<br><input name="discount_value" type="number" step="0.01" value="0" min="0"></label></div>
      <div class="col12"><label>Notes<br><input name="notes"></label></div>
    </form>
  </div>
  <div class="dialog-actions">
    <button class="ghost" data-close>Cancel</button>
    <button id="btnSaveCustomer" class="green">Save</button>
  </div>
</dialog>

<!-- INVENTORY DIALOG -->
<dialog id="invDialog">
  <div class="dialog-head">
    <strong id="invDialogTitle">New Item</strong>
    <div class="right"></div>
    <button class="ghost" data-close>Close</button>
  </div>
  <div class="dialog-body">
    <form id="invForm" class="formgrid">
      <input type="hidden" name="id">
      <input type="hidden" name="image_path">
      <!-- Image Section -->
      <div class="col3">
        <div class="form-section">
          <h4>Item Image</h4>
          <div class="image-upload-container">
            <div id="imagePreview" class="image-preview">
              <img id="previewImg" src="" style="display: none; max-width: 100%; max-height: 200px; border-radius: 8px;">
              <div id="uploadPlaceholder" class="upload-placeholder">
                <span>üì∑</span>
                <span>Click to upload image</span>
              </div>
            </div>
            <div class="image-actions">
              <input type="file" id="imageUpload" accept="image/*" style="display: none;">
              <button type="button" id="btnUploadImage" class="ghost">Upload Image</button>
              <button type="button" id="btnRemoveImage" class="ghost" style="display: none;">Remove</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Basic Information Section -->
      <div class="col3">
        <div class="form-section">
          <h4>Basic Information</h4>
          <div class="field-row">
            <div class="field-group">
              <label>SKU *<br><input name="sku" required placeholder="Unique identifier"></label>
            </div>
            <div class="field-group">
              <label>Name *<br><input name="name" required placeholder="Item name"></label>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Category<br><input name="category" placeholder="e.g., Electronics, Furniture"></label>
            </div>
            <div class="field-group">
              <label>Location<br><input name="location" placeholder="Storage location"></label>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>Unit<br><input name="unit" placeholder="pcs, set, box, etc."></label>
            </div>
            <div class="field-group">
              <label>Tags<br><input name="tags" placeholder="rental, indoor, outdoor, etc."></label>
            </div>
          </div>
        </div>
      </div>

      <!-- Inventory Management Section -->
      <div class="col3">
        <div class="form-section">
          <h4>Inventory Management</h4>
          <div class="field-row">
            <div class="field-group">
              <label>Total Quantity<br><input name="qty_total" type="number" step="1" min="0" value="0"></label>
            </div>
            <div class="field-group">
              <label>Available Now<br><input name="qty_available" type="number" step="1" min="0" value="0"></label>
            </div>
            <div class="field-group">
              <label>Safety Stock<br><input name="safety_stock" type="number" step="1" min="0" value="0"></label>
            </div>
          </div>
          <div class="note">üí° Leave "Available Now" blank to default to Total Quantity</div>
        </div>
      </div>

      <!-- Pricing Section -->
      <div class="col3">
        <div class="form-section">
          <h4>Pricing</h4>
          <div class="field-row">
            <div class="field-group">
              <label>Cost Price<br><input name="cost" type="number" step="0.01" min="0" value="0" placeholder="0.00"></label>
            </div>
            <div class="field-group">
              <label>Rental Price<br><input name="price" type="number" step="0.01" min="0" value="0" placeholder="0.00"></label>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Information Section -->
      <div class="col3">
        <div class="form-section">
          <h4>Additional Information</h4>
          <div class="field-row">
            <div class="field-group full-width">
              <label>Notes<br><textarea name="notes" placeholder="Additional notes about this item..." rows="3"></textarea></label>
            </div>
          </div>
        </div>
      </div>
    </form>
    <div class="note">Hint: If you leave ‚ÄúAvailable now‚Äù blank, it will default to Total quantity.</div>
  </div>
  <div class="dialog-actions">
    <button class="ghost" data-close>Cancel</button>
    <button id="btnSaveItem" class="green">Save Item</button>
  </div>
</dialog>

<!-- EVENT DIALOG -->
<dialog id="evtDialog">
  <div class="dialog-head">
    <strong id="evtDialogTitle">New Event</strong>
    <div class="right"></div>
    <button class="ghost" data-close>Close</button>
  </div>
  <div class="dialog-body">
    <form id="evtForm" class="formgrid">
      <input type="hidden" name="id">
      <div class="col6"><label>Event name<br><input name="name" required></label></div>
      <div class="col6"><label>Client<br><input name="client"></label></div>
      <div class="col6"><label>Date<br><input type="date" name="date"></label></div>
      <div class="col6"><label>Location<br><input name="location"></label></div>
      <div class="col6"><label>Contact<br><input name="contact" placeholder="email or phone"></label></div>
      <div class="col6"><label>Status<br>
        <select name="status">
          <option>planned</option><option>active</option><option>done</option><option>cancelled</option>
        </select></label>
      </div>
      <div class="col6"><label>Notes<br><input name="notes"></label></div>
    </form>
  </div>
  <div class="dialog-actions">
    <button class="ghost" data-close>Cancel</button>
    <button id="btnSaveEvent" class="green">Save</button>
  </div>
</dialog>

<!-- SETTINGS -->
<dialog id="settingsDialog">
  <div class="dialog-head">
    <strong>Settings</strong>
    <div class="right"></div>
    <button class="ghost" data-close>Close</button>
  </div>
  <div class="dialog-body">
    <form id="settingsForm" class="formgrid">
      <div class="col6"><label>Business name<br><input name="biz_name"></label></div>
      <div class="col6"><label>Phone<br><input name="biz_phone"></label></div>
      <div class="col6"><label>Address<br><input name="biz_address"></label></div>
      <div class="col6"><label>Email<br><input name="biz_email"></label></div>
      <div class="col6"><label>Logo URL (optional)<br><input name="logo" placeholder="https://‚Ä¶"></label></div>
      <div class="col6"><label>Currency symbol<br><input name="currency" value="$"></label></div>
      <div class="col6"><label>Tax rate (%)<br><input name="tax" type="number" step="0.001" value="0"></label></div>
    </form>
  </div>
  <div class="dialog-actions">
    <button class="ghost" data-close>Cancel</button>
    <button id="btnSaveSettings" class="green">Save</button>
  </div>
</dialog>



<!-- Include the database client -->
<script src="database-client.js"></script>
<script src="js/inventory.js"></script>
<script src="js/events.js"></script>
<script src="js/settings.js"></script>
<script src="js/customers.js"></script>

<script>
/* ========= Utilities & Storage ========= */
// These functions are already defined in database-client.js, so we don't need to redeclare them
// const $ = sel => document.querySelector(sel);
// const $$ = sel => Array.from(document.querySelectorAll(sel));
// const nowISO = () => new Date().toISOString();
// const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
// function byId(arr, id){ return arr.find(x=>x.id===id); }
// function idxById(arr,id){ return arr.findIndex(x=>x.id===id); }
// function fmtMoney(n, sym){return (sym||'$')+Number(n||0).toFixed(2);}
// function escapeHtml(s){return (s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

// Wait for database to be ready
let dbReady = false;

// Listen for database loaded event
window.addEventListener('databaseLoaded', async (event) => {
  console.log('üîÑ Database loaded event received:', event.detail);
  
  if (event.detail.success) {
    dbReady = true;
    console.log('‚úÖ Database ready, initializing UI...');
    console.log('DB state:', { 
      settings: DB.settings, 
      inventory: DB.inventory.length, 
      events: DB.events.length 
    });
    
    // Initialize all modules
    if (typeof initInventory === 'function') {
      console.log('üîß Initializing inventory module...');
      initInventory();
    }
    if (typeof initEvents === 'function') {
      console.log('üîß Initializing events module...');
      initEvents();
    }
    if (typeof initSettings === 'function') {
      console.log('üîß Initializing settings module...');
      initSettings();
    }
    if (typeof initCustomers === 'function') {
      console.log('üîß Initializing customers module...');
      initCustomers();
    }
    
    // Initialize remaining UI components
    if (typeof renderCheckouts === 'function') renderCheckouts();
    if (typeof renderDashboard === 'function') renderDashboard();
    if (typeof renderReports === 'function') renderReports();
    
    console.log('‚úÖ All modules initialized');
  } else {
    console.error('‚ùå Database failed to load');
  }
});

// Fallback initialization in case the event doesn't fire
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üîÑ DOM loaded, waiting for database...');
  
  // Wait a bit for database to load
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  if (!dbReady) {
    console.log('‚ö†Ô∏è Database not ready, attempting initialization anyway...');
    
    // Initialize all modules
    if (typeof initInventory === 'function') initInventory();
    if (typeof initEvents === 'function') initEvents();
    if (typeof initSettings === 'function') initSettings();
    if (typeof initCustomers === 'function') initCustomers();
    
    // Initialize remaining UI components
    if (typeof renderCheckouts === 'function') renderCheckouts();
    if (typeof renderDashboard === 'function') renderDashboard();
    if (typeof renderReports === 'function') renderReports();
  }
});

/* ========= Tab Navigation ========= */
$$('.nav .tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    $$('.nav .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.getAttribute('data-tab');
    document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
    document.getElementById(tab).classList.remove('hidden');
  });
});

/* ========= Inventory ========= */
// Inventory functions are now in js/inventory.js

// Inventory functions are now in js/inventory.js

/* ========= Events ========= */
// Events functions are now in js/events.js

/* ========= Checkout & Returns ========= */
const coEvent=$('#coEvent'), coDue=$('#coDue'), coLines=$('#coLines');
const btnFinalizeCo=$('#btnFinalizeCo'), btnClearCo=$('#btnClearCo');
const coAddDialog=$('#coAddDialog'), coAddSearch=$('#coAddSearch'), coAddBody=$('#coAddBody');
const btnCoAddSave=$('#btnCoAddSave'), btnOpenCoAdd=$('#btnOpenCoAdd');
const coCustomer=$('#coCustomer'), coCustDiscLabel=$('#coCustDiscLabel');
const coManualDiscType=$('#coManualDiscType'), coManualDiscValue=$('#coManualDiscValue');
let coDraft = {event_id:'',due_date:'',lines:[], customer_id:'', discount:{type:'none',value:0}, manual_discount:{type:'none',value:0}}; // lines: {item_id,sku,name,qty,unit_price}
function fillEventSelects(){
  const opts = (DB.events||[]).map(e=>`<option value="${e.id}">${escapeHtml((e.date||'')+' ‚Äî '+e.name)}</option>`).join('');
  coEvent.innerHTML = `<option value="">Select event‚Ä¶</option>`+opts;
  const retOpts = (DB.checkouts||[]).map(c=>{
    const ev = byId(DB.events||[], c.event_id)||{name:'[deleted]'};
    const status = c.returned?'returned':'open';
    return `<option value="${c.id}">${escapeHtml((c.date||'').slice(0,10)+' ‚Äî '+ev.name+' ‚Äî '+(c.items||[]).length+' item(s) ‚Äî '+status)}</option>`;
  }).join('');
  const prevRet = (retCheckout && retCheckout.value) || '';
  $('#retCheckout').innerHTML = `<option value="">Select checkout‚Ä¶</option>` + retOpts;
  if (retCheckout) retCheckout.value = prevRet;
  // Customers
  coCustomer.innerHTML = `<option value="">Select customer‚Ä¶</option>` + (DB.customers||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.name||'')}</option>`).join('');
}
/* Add Inventory modal rendering */
function renderCoAddList(){
  const q=(coAddSearch.value||'').toLowerCase();
  const rows=DB.inventory.filter(i=>{
    return [i.sku,i.name,i.category].join(' ').toLowerCase().includes(q);
  }).map(i=>{
    const max=i.qty_available||0;
    const disabled = max<=0 ? 'disabled' : '';
    const lowCls = i.qty_available <= (i.safety_stock || 0) ? 'low' : 'good';
    const tags = (i.tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('');
    const imageCell = i.image_path ? 
      `<img src="${escapeHtml(i.image_path)}" alt="${escapeHtml(i.name)}" class="inventory-image" onerror="this.style.display='none'">` : 
      '<div style="width:40px;height:40px;background:#1b2330;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#a7b0bf;font-size:12px;">üì¶</div>';
    const curSym = DB.settings?.currency_symbol || DB.settings?.currencySymbol || '$';
    return `
      <tr>
        <td>${imageCell}</td>
        <td><small class="mono">${escapeHtml(i.sku)}</small></td>
        <td>${escapeHtml(i.name)}</td>
        <td>${escapeHtml(i.category || '')}</td>
        <td>${escapeHtml(i.location || '')}</td>
        <td>${escapeHtml(i.unit || '')}</td>
        <td><span class="badge ${lowCls}">${i.qty_available}</span> / ${i.qty_total}</td>
        <td>${fmtMoney(i.price, curSym)}</td>
        <td>${i.safety_stock || 0}</td>
        <td>${tags}</td>
        <td class="row-actions">
          <input type="number" min="0" step="1" value="0" max="${max}" data-coadd-qty="${i.id}" style="width:90px" ${disabled}>
          <button class="ghost" data-coadd-inc="${i.id}" ${disabled}>+1</button>
        </td>
      </tr>`;
  }).join('');
  coAddBody.innerHTML = rows || `<tr><td colspan="11" style="color:#9ab">No matches.</td></tr>`;
}
coAddSearch && (coAddSearch.oninput = renderCoAddList);
btnOpenCoAdd && (btnOpenCoAdd.onclick = ()=>{ renderCoAddList(); coAddDialog.showModal(); });
coAddDialog?.addEventListener('click', e=>{ if(e.target?.hasAttribute?.('data-close')) coAddDialog.close(); });
coAddBody?.addEventListener('click', e=>{
  const incId = e.target.getAttribute('data-coadd-inc'); if(!incId) return;
  const input = coAddBody.querySelector(`input[data-coadd-qty="${incId}"]`);
  if(!input) return; const max = Number(input.getAttribute('max')||0);
  const cur = Math.min(max, Math.max(0, Number(input.value||0)+1));
  input.value = cur;
});
btnCoAddSave && (btnCoAddSave.onclick = ()=>{
  const qtyInputs = Array.from(coAddBody.querySelectorAll('input[data-coadd-qty]'));
  let any=false;
  for(const inp of qtyInputs){
    const id = inp.getAttribute('data-coadd-qty');
    const qty = Math.max(0, Math.floor(Number(inp.value||0)));
    if(qty>0){
      const item = byId(DB.inventory, id); if(!item) continue;
      const exists = coDraft.lines.find(l=>l.item_id===id);
      if(exists){ exists.qty = Math.min((exists.qty||0)+qty, item.qty_available); }
      else { coDraft.lines.push({item_id:item.id, sku:item.sku, name:item.name, qty:Math.min(qty,item.qty_available), unit_price:Number(item.price||0)}); }
      any=true;
    }
  }
  if(any){ renderCoLines(); coAddDialog.close(); }
  else { alert('Select quantities to add.'); }
});
function renderCoLines(){
  const curSym = DB.settings.currency_symbol||'$';
  coLines.innerHTML = coDraft.lines.map(l=>{
    const line = Number(l.qty||0)*Number(l.unit_price||0);
    return `<tr>
      <td class="mono">${escapeHtml(l.sku)}</td>
      <td>${escapeHtml(l.name)}</td>
      <td><input type="number" min="1" step="1" value="${l.qty}" data-qty="${l.item_id}" style="width:80px"></td>
      <td><input type="number" min="0" step="0.01" value="${l.unit_price}" data-price="${l.item_id}" style="width:110px"></td>
      <td>${fmtMoney(line,curSym)}</td>
      <td class="row-actions"><button class="ghost" data-remline="${l.item_id}">Remove</button></td>
    </tr>`;
  }).join('') || `<tr><td colspan="6" style="color:#9ab">No lines yet ‚Äî add items from the left.</td></tr>`;
  recomputeTotals();
}
function recomputeTotals(){
  const curSym = DB.settings.currency_symbol||'$';
  const sub = coDraft.lines.reduce((a,b)=>a + Number(b.qty||0)*Number(b.unit_price||0), 0);
  // Customer discount
  let custDiscount = 0;
  const cust = byId(DB.customers||[], coDraft.customer_id);
  if(cust && cust.discount_type && cust.discount_type!=='none'){
    if(cust.discount_type==='percent') custDiscount = sub * (Number(cust.discount_value||0)/100);
    else if(cust.discount_type==='amount') custDiscount = Math.min(Number(cust.discount_value||0), sub);
  }
  // Manual discount
  let manualDiscount = 0;
  if(coDraft.manual_discount?.type==='percent') manualDiscount = sub * (Number(coDraft.manual_discount.value||0)/100);
  else if(coDraft.manual_discount?.type==='amount') manualDiscount = Math.min(Number(coDraft.manual_discount.value||0), sub);
  const totalDiscount = Math.min(sub, custDiscount + manualDiscount);
  const taxable = Math.max(0, sub - totalDiscount);
  const taxRate = (DB.settings.tax_rate ?? DB.settings.taxRate ?? 0);
  const tax = taxable * (Number(taxRate)/100);
  const tot = taxable + tax;
  $('#coSubtotal').textContent = fmtMoney(sub,curSym);
  // Toggle discount rows and labels
  const hasCust = custDiscount > 0.000001;
  const hasManual = manualDiscount > 0.000001;
  const custRow = document.getElementById('coCustDiscRow');
  const manualRow = document.getElementById('coManualDiscRow');
  const manualLabel = document.getElementById('coManualDiscLabel');
  if(custRow) custRow.style.display = hasCust ? '' : 'none';
  if(manualRow) manualRow.style.display = hasManual ? '' : 'none';
  if(manualLabel) manualLabel.textContent = hasCust ? 'Additional Discount' : 'Discount';
  const custCell = document.getElementById('coCustDiscount');
  const manualCell = document.getElementById('coManualDiscount');
  if(custCell) custCell.textContent = fmtMoney(custDiscount,curSym);
  if(manualCell) manualCell.textContent = fmtMoney(manualDiscount,curSym);
  $('#coTax').textContent = fmtMoney(tax,curSym);
  $('#coTotal').textContent = fmtMoney(tot,curSym);
  const label = cust ? (cust.discount_type==='percent' ? `${Number(cust.discount_value||0)}%` : (cust.discount_type==='amount' ? fmtMoney(cust.discount_value,curSym) : '‚Äî')) : '‚Äî';
  coCustDiscLabel.textContent = label;
}
coLines.addEventListener('input',(e)=>{
  const qtyId = e.target.getAttribute('data-qty');
  const priceId = e.target.getAttribute('data-price');
  if(qtyId){
    const it = byId(DB.inventory, qtyId); const line = coDraft.lines.find(l=>l.item_id===qtyId);
    let v = Math.max(1, Math.floor(Number(e.target.value||1)));
    if(it) v = Math.min(v, it.qty_available);
    line.qty = v; e.target.value = v;
    renderCoLines();
  }
  if(priceId){
    const line = coDraft.lines.find(l=>l.item_id===priceId);
    let v = Math.max(0, Number(e.target.value||0)); line.unit_price = v; e.target.value = v;
    renderCoLines();
  }
});
coLines.addEventListener('click',(e)=>{
  const rem = e.target.getAttribute('data-remline');
  if(rem){ coDraft.lines = coDraft.lines.filter(l=>l.item_id!==rem); renderCoLines(); }
});
coCustomer.addEventListener('change', ()=>{ coDraft.customer_id = coCustomer.value||''; recomputeTotals(); });
coManualDiscType.addEventListener('change', ()=>{ coDraft.manual_discount.type = coManualDiscType.value; recomputeTotals(); });
coManualDiscValue.addEventListener('input', ()=>{ coDraft.manual_discount.value = Number(coManualDiscValue.value||0); recomputeTotals(); });
btnClearCo.onclick=()=>{ coDraft={event_id:'',due_date:'',lines:[],customer_id:'',discount:{type:'none',value:0},manual_discount:{type:'none',value:0}}; coEvent.value=''; coDue.value=''; coCustomer.value=''; coManualDiscType.value='none'; coManualDiscValue.value='0'; renderCoLines(); };
btnFinalizeCo.onclick=async()=>{
  if(!coEvent.value){ alert('Choose an event.'); return; }
  if(!coDue.value){ alert('Please specify a due date for the checkout.'); return; }
  if(coDraft.lines.length===0){ alert('Add at least one line.'); return; }
  // ensure availability
  for(const l of coDraft.lines){
    const it = byId(DB.inventory, l.item_id);
    if(!it || it.qty_available<l.qty){ alert(`Insufficient availability for ${it?.name||l.sku}.`); return; }
  }
  
  const sub = coDraft.lines.reduce((a,b)=>a+(b.qty*b.unit_price),0);
  // compute discounts and totals
  let custDiscount = 0; const cust = byId(DB.customers||[], coDraft.customer_id);
  if(cust && cust.discount_type && cust.discount_type!=='none'){
    if(cust.discount_type==='percent') custDiscount = sub * (Number(cust.discount_value||0)/100);
    else if(cust.discount_type==='amount') custDiscount = Math.min(Number(cust.discount_value||0), sub);
  }
  let manualDiscount = 0;
  if(coDraft.manual_discount?.type==='percent') manualDiscount = sub * (Number(coDraft.manual_discount.value||0)/100);
  else if(coDraft.manual_discount?.type==='amount') manualDiscount = Math.min(Number(coDraft.manual_discount.value||0), sub);
  const totalDiscount = Math.min(sub, custDiscount + manualDiscount);
  const taxable = Math.max(0, sub - totalDiscount);
  const taxRate = (DB.settings.tax_rate ?? DB.settings.taxRate ?? 0);
  const tax = taxable*(Number(taxRate)/100);
  const total = taxable+tax;
  const co = {
    id: uid(),
    event_id: coEvent.value,
    customer_id: coDraft.customer_id||'',
    due_date: coDue.value||'',
    items: coDraft.lines.map(l=>({item_id:l.item_id,sku:l.sku,name:l.name,qty:Number(l.qty),unit_price:Number(l.unit_price)})),
    subtotal: sub, 
    tax, 
    total, 
    discounts: { customer: custDiscount, manual: manualDiscount, total: totalDiscount, manual_type: coDraft.manual_discount?.type||'none' }
  };
  
  try {
    // Save checkout to database (this will automatically update inventory via triggers)
    const success = await saveCheckout(co);
    if (!success) {
      alert('Failed to create checkout. Please try again.');
      return;
    }
    
    // Refresh inventory from database to get updated quantities
    DB.inventory = await api.getInventory();
    
    const ev = byId(DB.events, co.event_id);
    
    // Show success message
    const eventName = ev?.name || 'Event';
    const customerName = cust?.name || '';
    const customerText = customerName ? ` for ${customerName}` : '';
    const itemCount = co.items.length;
    const itemText = itemCount === 1 ? 'item' : 'items';
    
    alert(`‚úÖ Checkout completed successfully!\n\n` +
          `Event: ${eventName}${customerText}\n` +
          `Items: ${itemCount} ${itemText}\n` +
          `Total: ${fmtMoney(total, DB.settings.currency_symbol||'$')}\n\n` +
          `You can view and print the invoice in the Reports section.`);
    
    // reset builder
    coDraft={event_id:'',due_date:'',lines:[],customer_id:'',discount:{type:'none',value:0},manual_discount:{type:'none',value:0}}; 
    coEvent.value=''; coDue.value=''; coCustomer.value=''; coManualDiscType.value='none'; coManualDiscValue.value='0';
    renderCoLines(); 
    if (typeof renderInventory === 'function') renderInventory(); // Refresh inventory display
    renderReports();
    if (typeof renderDashboard === 'function') renderDashboard();
    renderCheckouts();
  } catch (error) {
    console.error('Failed to create checkout:', error);
    alert('Failed to create checkout. Please try again.');
  }
};

function outQtyForItem(itemId){
  let out=0;
  for(const co of (DB.checkouts||[])){
    for(const l of (co.items||[])){ if(l.item_id===itemId) out += l.qty; }
    for(const r of (co.returns||[])){ if(r.item_id===itemId) out -= r.qty; }
  }
  return out;
}

/* Returns */
const retCheckout=$('#retCheckout'), retBody=$('#retBody');
$('#btnLoadReturns').onclick = renderReturns;
retCheckout?.addEventListener('change', ()=>{
  // Only load items when user explicitly clicks Load
  if (retBody) retBody.innerHTML = `<tr><td colspan="5" style="color:#9ab">Click Load to view items.</td></tr>`;
});
function renderReturns(){
  const id = retCheckout.value; retBody.innerHTML='';
  const co = byId(DB.checkouts||[], id);
  if(!co){ retBody.innerHTML = `<tr><td colspan="5" style="color:#9ab">Choose a checkout.</td></tr>`; return; }
  const returnedMap = {};
  for(const r of (co.returns||[])){ returnedMap[r.item_id]=(returnedMap[r.item_id]||0)+Number(r.qty||0); }
  retBody.innerHTML = (co.items||[]).map(l=>{
    const ret = returnedMap[l.item_id]||0;
    const out = l.qty - ret;
    return `<tr>
      <td class="mono">${escapeHtml(l.sku)}</td>
      <td>${escapeHtml(l.name)}</td>
      <td>${l.qty}</td>
      <td>${ret}</td>
      <td><input type="number" min="0" max="${out}" step="1" value="${out?out:0}" data-ret="${l.item_id}" style="width:80px" ${out?'':'disabled'}></td>
    </tr>`;
  }).join('');
}
$('#btnProcessReturns').onclick = async()=>{
  const id = retCheckout.value; const co = byId(DB.checkouts||[],id);
  if(!co){ alert('Choose a checkout first.'); return; }
  const retInputs = Array.from(retBody.querySelectorAll('input[data-ret]'));
  if(retInputs.length===0){ alert('Nothing to return.'); return; }
  
  const returns = [];
  for(const inp of retInputs){
    const itemId = inp.getAttribute('data-ret');
    const qty = Math.max(0, Math.floor(Number(inp.value||0)));
    if(qty>0){
      returns.push({item_id:itemId, qty});
    }
  }
  if(returns.length===0){ alert('Enter return quantities.'); return; }
  
  try {
    // Process returns via database (this will automatically update inventory via triggers)
    const success = await processReturns(id, returns);
    if (!success) {
      alert('Failed to process returns. Please try again.');
      return;
    }
    
    // Refresh inventory from database to get updated quantities
    DB.inventory = await api.getInventory();
    // Refresh checkouts to exclude archived ones
    DB.checkouts = await api.getCheckouts();
    
    alert('Returns processed successfully!');
    // Refresh dropdown options and clear UI
    fillEventSelects();
    if (retCheckout) retCheckout.value = '';
    if (retBody) retBody.innerHTML = `<tr><td colspan="5" style="color:#9ab">Choose a checkout.</td></tr>`;
    if (typeof renderInventory === 'function') renderInventory(); // Refresh inventory display
    renderReports();
    if (typeof renderDashboard === 'function') renderDashboard();
  } catch (error) {
    console.error('Failed to process returns:', error);
    alert('Failed to process returns. Please try again.');
  }
};

/* ========= Reports & Invoices ========= */
const invoiceSelect=$('#invoiceSelect'), invoiceArea=$('#invoiceArea'), togglePrices=$('#togglePrices');

function renderDashboard(){
  // Dashboard Quick Stats
  const setText = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };
  setText('dbStatItems', (DB.inventory||[]).length);
  setText('dbStatEvents', (DB.events||[]).length);
  setText('dbStatCO', (DB.checkouts||[]).length);
  setText('dbStatLow', (DB.inventory||[]).filter(i=>i.qty_available <= (i.safety_stock||0)).length);
  setText('dbStatCustomers', (DB.customers||[]).length);
  // Dashboard Recent Activity (all entries)
  const acts = (DB.activity||[]);
  const cnt = document.getElementById('dbActCount'); if (cnt) cnt.textContent = `${acts.length} records`;
  const body = document.getElementById('dbActBody');
  if (body) body.innerHTML = acts.map(a=>`
    <tr>
      <td>${escapeHtml((a.date||'').slice(0,10))}</td>
      <td><span class="tag">${escapeHtml(a.type||'')}</span></td>
      <td>${escapeHtml(a.ref||'')}</td>
      <td>${escapeHtml(a.details||'')}</td>
    </tr>`).join('');
}

function renderReports(){
  // Only invoices now
  invoiceSelect.innerHTML = (DB.checkouts||[]).map(co=>{
    const ev = byId(DB.events||[], co.event_id) || {name:'[deleted]'};
    const label = `${(co.date||'').slice(0,10)} ‚Äî ${ev.name} ‚Äî ${(co.items||[]).length} item(s)`;
    return `<option value="${co.id}">${escapeHtml(label)}</option>`;
  }).join('');
}
function openInvoice(checkoutId){
  const co = byId(DB.checkouts, checkoutId);
  if(!co){ alert('Invoice not found'); return; }
  const withPrices = togglePrices.checked;
  const ev = byId(DB.events, co.event_id) || {};
  const s = DB.settings || {};
  const biz = s.business || {};
  const currency = s.currencySymbol || '$';
  const lineRows = co.items.map(l=>{
    const lineTotal = (l.unit_price||0) * (l.qty||0);
    return `<tr>
      <td>${escapeHtml(l.sku||'')}</td>
      <td>${escapeHtml(l.name||'')}</td>
      <td>${l.qty}</td>
      ${withPrices ? `<td>${currency}${Number(l.unit_price||0).toFixed(2)}</td><td>${currency}${lineTotal.toFixed(2)}</td>` : ``}
    </tr>`;
  }).join('');
  const totalsBlock = withPrices?`
    <div class="totals">
      <table>
        <tr><th>Subtotal</th><td style="text-align:right">${fmtMoney(co.subtotal||0,currency)}</td></tr>
        <tr><th>Discounts</th><td style="text-align:right">${fmtMoney((co.discounts?.total)||0,currency)}</td></tr>
        <tr><th>Tax</th><td style="text-align:right">${fmtMoney(co.tax||0,currency)}</td></tr>
        <tr><th>Total</th><td style="text-align:right"><strong>${fmtMoney(co.total||0,currency)}</strong></td></tr>
      </table>
    </div>`:'';
  invoiceArea.classList.add('active');
  invoiceArea.innerHTML = `
    <div class="invoice">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
        <div>
          <h2>${escapeHtml(biz.name || 'Invoice')}</h2>
          <small>${escapeHtml(biz.address||'')}</small><br>
          <small>${escapeHtml(biz.phone||'')}</small><br>
          <small>${escapeHtml(biz.email||'')}</small>
        </div>
        <div style="text-align:right">
          ${biz.logo ? `<img src="${biz.logo}" alt="logo" style="max-height:60px;max-width:220px;object-fit:contain">` : ''}
          <div><small><strong>Invoice #</strong> ${escapeHtml(co.id)}</small></div>
          <div><small><strong>Date</strong> ${(co.date||'').slice(0,10)}</small></div>
          <div><small><strong>Due</strong> ${escapeHtml(co.due_date||'')}</small></div>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:24px;flex-wrap:wrap">
        <div>
          <strong>Bill To</strong><br>
          <div>${escapeHtml(ev.client||'')}</div>
          <small>${escapeHtml(ev.contact||'')}</small>
        </div>
        <div>
          <strong>Event</strong><br>
          <div>${escapeHtml(ev.name||'')}</div>
          <small>${escapeHtml(ev.location||'')}</small><br>
          <small>${escapeHtml(ev.date||'')}</small>
        </div>
      </div>
      <table style="margin-top:16px">
        <thead>
          <tr>
            <th style="width:140px">SKU</th>
            <th>Item</th>
            <th style="width:80px">Qty</th>
            ${withPrices ? `<th style="width:120px">Unit</th><th style="width:120px">Line</th>` : ``}
          </tr>
        </thead>
        <tbody>${lineRows}</tbody>
      </table>
      ${totalsBlock}
      <div style="margin-top:12px"><small>Customer: ${escapeHtml((byId(DB.customers||[],co.customer_id)||{}).name||'')}</small></div>
    </div>`;
}
$('#btnOpenInvoice').onclick = ()=>{ const id = invoiceSelect.value; if(!id){alert('Choose an invoice');return;} openInvoice(id); };
$('#btnPrintInvoice').onclick = ()=>{ if(!invoiceArea.classList.contains('active')){ const id=invoiceSelect.value; if(id) openInvoice(id);} window.print(); };
togglePrices.addEventListener('change', ()=>{ const id=invoiceSelect.value; if(id) openInvoice(id); });

/* ========= Settings ========= */
// Settings functions are now in js/settings.js



/* ========= Checkout/Returns: wiring + reports refreshers ========= */
function renderCheckouts(){
  fillEventSelects();
  renderCoLines();
}

function renderReturns(){
  // if a checkout is preselected, refresh the table; otherwise just ensure selects are filled
  fillEventSelects();
  const id = retCheckout?.value; if (!id) return;
  retBody && (retBody.innerHTML='');
  const co = byId(DB.checkouts||[], id);
  if(!co){ if(retBody) retBody.innerHTML = `<tr><td colspan="5" style="color:#9ab">Choose a checkout.</td></tr>`; return; }
  const returnedMap = {};
  for(const r of (co.returns||[])){ returnedMap[r.item_id]=(returnedMap[r.item_id]||0)+Number(r.qty||0); }
  if (retBody) retBody.innerHTML = (co.items||[]).map(l=>{
    const ret = returnedMap[l.item_id]||0;
    const out = l.qty - ret;
    return `<tr>
      <td class="mono">${escapeHtml(l.sku)}</td>
      <td>${escapeHtml(l.name)}</td>
      <td>${l.qty}</td>
      <td>${ret}</td>
      <td><input type="number" min="0" max="${out}" step="1" value="${out?out:0}" data-ret="${l.item_id}" style="width:80px" ${out?'':'disabled'}></td>
    </tr>`;
  }).join('');
}

/* ========= Initial Render ========= */
// Initialization is now handled in the DOMContentLoaded event above
</script>
</body>
</html>
